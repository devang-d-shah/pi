-- What is the average claim value per breed? 

-- Note: Since the claims table does not tell which insured entity the claim was for,
-- I have distributed the payout value against all insured entities in the policy equally per payout

with pets_per_policy as(
SELECT p.ref , e.breed, count(*) over (partition by p.ref) as policy_pet_count FROM `ds-de-sandbox-66.pi.policies` p cross join unnest(data.insured_entities) e
)
select breed, avg(payout/policy_pet_count) as avg_claim_value from pets_per_policy p inner join  `ds-de-sandbox-66.pi.claims`  c
on cast(p.ref as integer) = c.policy_reference
where payout>0
group by breed
order by 1

/*
breed	avg_claim_value
AFFENPINSCHER	3797.2125845694159
AIREDALE_TERRIER	33169.623475493208
AKITA	7954.9401975563887
ALASKAN_MALAMUTE	20642.985362641532
ALSATIAN	14440.950855320109
AMERICAN_AKITA	27127.355210528989
AMERICAN_BULL_DOG	27459.7508241846
AMERICAN_CURL	25.262535544185472
AMERICAN_STAFFORDSHIRE_TERRIER	1538.0944126431459
ARABIAN_MAU	18881.6095391574
AUSTRALIAN_KELPIE	4794.2365727318465
AUSTRALIAN_LABRADOODLE_(MINI)	18927.906685574842
BASENJI	2815.19968110716
BASSET_GRIFFON_VENDEEN_(GRAND)	46373.594522498432
BASSET_HOUND	15152.495589915881
BEAGLE	11495.367487178
BEARDED_COLLIE	6416.1341920949544
BEAUCERON	28436.703432977516
BEDLINGTON_TERRIER	18525.365356232127
BELGIAN_SHEPHERD_DOG_MALINOIS	16704.130898207684
BENGAL	9418.8262968664949
BERNESE_MOUNTAIN_DOG	19374.092535021438
BICHON_FRISE	6412.674884135201
BICH_POO	7651.4215506588016
BICOLOUR	6540.5050991003382
BIEWER_TERRIER	6165.3696159503079
BIRMAN	4981.0878610547516
BLACK	679.63294893239038
BLACK_AND_WHITE_LONGHAIR	1933.9696296324014
BLACK_AND_WHITE_SHORTHAIR	21179.994217179024
BLACK_LABRADOR	11381.540455255041
BLACK_SHORTHAIR	2752.124576888164
BLUE_MERLE_COLLIE	3820.062303203209
BLUE_SHORTHAIR	6403.761313693175
BORADOR	8296.8314234849968
BORDERNESE	13645.630500466959
BORDER_COLLIE	17281.544215992424
BORDER_TERRIER	21694.329058191131
BORDOODLE	14837.480661422414
BOSTON_TERRIER	21535.263188020108
BOXER	9763.1866311441026
BRACCO_ITALIANO	9790.332413277496
BRITISH_BLACK_SHORTHAIR	30093.740854492593
BRITISH_BLUE_SHORTHAIR	2002.4494378073059
BRITISH_CREAM_SHORTHAIR	10282.284408688156
BRITISH_SHORTHAIR	17354.920599066547
BRITISH_SPOTTED_SHORTHAIR	17023.217550381272
BRITISH_TABBY_SHORTHAIR	6880.3560170556666
BRITISH_TIPPED_SHORTHAIR	477.00892012579538
BRITTANY	11311.819559856569
BULLDOG	16949.484648287729
BULLMASTIFF	15178.542490146934
BULL_TERRIER	40531.508004610805
BURMESE	18681.488328545172
BURMESE_BROWN	34651.658301802323
BURMESE_LILAC	15146.866152194305
CAIRN_TERRIER	11688.329532304428
CANE_CORSO	27901.018048136735
CAVACHON	25118.585102053461
CAVALIER_KING_CHARLES_SPANIEL	16026.757094017818
CAVAPOO	21728.892038159913
CHIHUAHUA	7973.1507026197332
CHIHUAHUA_LONG_COAT	11445.687716714268
CHIHUAHUA_SMOOTH_COAT	12515.422003046724
CHINESE_HAIRLESS	30981.401215677717
CHI_POO	3280.9777925139792
CHOCOLATE_LABRADOR_RETRIEVER	23606.265259992353
CHORKIE	46507.629030611155
CHOW_CHOW	16280.680603925812
CLUMBER_SPANIEL	13807.349263641279
COCKALIER	20798.453964426859
COCKAPOO	9805.1184629784875
COCKERPOO	14521.006925751202
COCKER_SPANIEL	15296.793692501105
COCK_A_TZU	5938.4145059161483
CORGI_WELSH_PEMBROKE	17898.697154078629
COTON_DE_TULEAR	7648.9058944687022
DACHSHUND	52793.690095747188
DACHSHUND_LONG_HAIRED	54669.828728869907
DACHSHUND_LONG_HAIRED_(MINIATURE)	21488.45422249789
DACHSHUND_SHORT_HAIRED	13588.747944243363
DACHSHUND_SHORT_HAIRED_(MINIATURE)	24335.883394368488
DACHSHUND_SMOOTH_HAIRED	6723.3228843480019
DACHSHUND_SMOOTH_HAIRED_(MINIATURE)	17428.709080000906
DACHSHUND_WIRE_HAIRED	5473.7025279156142
DACHSHUND_WIRE_HAIRED_(MINIATURE)	12887.202575734174
DALMATIAN	14921.630367801861
DANDIE_DINMONT_TERRIER	50704.174958300733
DOBERMAN	33256.627925286637
DOGUE_DE_BORDEAUX	13018.512908394707
DOMESTIC_LONGHAIR	8213.6165987522454
DOMESTIC_SEMI_LONG_HAIR	37974.752545482355
DOMESTIC_SHORTHAIR	8822.3177269434127
DORKIE	18933.697248379489
EMPATRICE_MALTESE	1702.1770202896871
ENGLISH_BULLDOG	24227.743119271548
ENGLISH_BULL_TERRIER	6089.85998883788
ENGLISH_POINTER	24431.965394042611
ENGLISH_SETTER	5389.9811051100405
ENGLISH_SPRINGER_SPANIEL	20703.262394051009
EXOTIC_SHORTHAIR	1557.4231762244071
FIELD_SPANIEL	2294.6708040629683
FLAT_COATED_RETRIEVER	20196.351719997794
FRENCHIE_PUG	20407.567480845588
FRENCH_BULLDOG	22687.40918188783
GALGO_CODE	15070.79021150778
GERMAN_POINTER	13638.339377890301
GERMAN_SHEPHERD	12085.683254623387
GERMAN_SHORTHAIRED_POINTER	15562.74323212687
GERMAN_WIRE_HAIRED_POINTER	7099.058437822524
GINGER_LONGHAIR	10659.741192844009
GOLDENDOODLE	7547.64078438249
GOLDEN_RETRIEVER	14324.778984199907
GORDON_SETTER	26201.67365936832
GREATER_SWISS_MOUNTAIN_DOG	4217.31300011785
GREAT_DANE	19523.119259766063
GREYHOUND	16859.999986310697
GRIFFON_BRUXELLOIS	54553.495256214141
HARRIER	12214.525353907193
HAVANESE	16279.243654855116
HUNGARIAN_PULI	21639.525751193723
HUNGARIAN_VIZSLA	14678.601677540537
HUNTAWAY	52829.071215339834
IRISH_SETTER	25145.766904797812
IRISH_TERRIER	29714.994659810225
ITALIAN_GREYHOUND	6505.5118145130182
JACK-A-POO	17166.31960455178
JACKIE-BICHON	33616.051814374267
JACK_CHI	12244.500323246528
JACK_RUSSELL	13101.002629136243
JACK_TZU	5979.9084268761835
JAPANESE_AKITA	74867.973192885489
JUG	54779.271626489739
KOOIKERHONDJE	3153.8807639223214
KORTHALS_GRIFFON	24971.732152588978
LA-CHON	26153.075698314406
LABRADINGER	7186.2012369273289
LABRADOODLE	15850.488104474145
LABRADOODLE_(MINIATURE)	17871.087336995006
LABRADOR_RETRIEVER	18087.433977031262
LAGOTTO_ROMAGNOLO	5546.30489370075
LAKELAND_TERRIER	95316.78776662497
LANCASHIRE_HEELER	1058.657135010714
LARGE_MONGREL_(MORE_THAN_20KG)	14183.204229450308
LEONBERGER	1660.9679743025315
LHASAPOO	10969.44033815379
LHASA_APSO	12415.861738271713
LONGHAIR_BLUE_CREAM_AND_WHITE	1467.1916435222952
LURCHER	8474.6778229983647
MAINE_COON	17742.36130104426
MAL-SHI	7417.5344852125609
MALCHI	108049.21258364621
MALTESE	9764.9442241276665
MALTI-POO	16951.0765510243
MANCHESTER_TERRIER	8004.4694131754841
MEDIUM_MONGREL_(10KG-20KG)	17448.654874832984
MI-KI	6352.8593381282863
MINIATURE_BULL_TERRIER	13481.418587752352
MINIATURE_GOLDENDOODLE	35034.967155685881
MINIATURE_PINSCHER	7705.570134546655
MINIATURE_POODLE	5393.8256846523354
MINIATURE_SCHNAUZER	14249.840699195296
MOGGIE	12812.137399795367
MOGGY	9565.5520405656571
MUNSTERLANDER	17594.57504065146
NEWFOUNDLAND	3559.3015608837004
NORFOLK_TERRIER	4146.3081511320443
NORWEGIAN_FOREST_CAT	19307.646500308663
NOVA_SCOTIA_DUCK_TOLLING_RETRIEVER	6107.2939881620532
OLDE_ENGLISH_BULLDOGGE	27567.006253179974
OLD_ENGLISH_SHEEPDOG	25168.647077086098
OLD_THYME_DORSET_BULLDOG	3665.1082756763067
ORIENTAL	1874.2013186914651
ORIENTAL_BLUE	133.43102976601961
ORIENTAL_TABBY	133.43102976601961
PAPILLON	8551.50570492876
PARSON_JACK_RUSSELL	10255.787561183581
PATTERDALE_TERRIER	30170.538044595956
PATTERJACK	18629.903569756836
PERRO_DE_PRESA_CANARIO	7647.7353298514772
PERSIAN	6794.5737457051155
POMERANIAN	17993.23853428146
POMSKY	45434.391752635165
POM_SHI	2260.7302341310519
POWDER_PUFF_CHINESE_CRESTED	30981.401215677717
PUG	16225.162292615603
RAGAMUFFIN	5403.1090588816287
RAGDOLL	15036.908708242325
RHODESIAN_RIDGEBACK	20235.590806042954
ROMANIAN_MIORITIC_SHEPHERD_DOG	11933.371798428283
ROTTWEILER	38935.196403224167
ROUGH_COLLIE	3125.1732810393823
RUSSIAN_BLUE	45359.659860355321
SALUKI	5967.45079876347
SAMOYED	19210.820494559077
SCOTTISH_FOLD	8539.6855636184519
SCOTTISH_TERRIER	13285.331249651797
SEMI-LONGHAIR	11737.676960506871
SHAR_PEI	26015.883262315849
SHEPADOODLE	192.12315057802749
SHETLAND_SHEEPDOG	14456.366074682825
SHIBA_INU	6864.5146597714465
SHIH_POO	10872.099791063813
SHIH_TZU	10459.223847648875
SHIPPOO	11171.025906209465
SHOLLIE	15016.856811509067
SIAMESE	13170.067031230516
SIAMESE_CHOCOLATE_POINT	4275.1294320134111
SIAMESE_CREAM_POINT	18733.45727426204
SIAMESE_FOREIGN_BLACK	1874.2013186914651
SIAMESE_RED_POINT	8965.0068008541421
SIAMESE_SEAL_POINT	1454.0917897639811
SIAMESE_TABBY_POINT	6767.2752610189109
SIBERIAN	2401.1148448561721
SIBERIAN_HUSKY	27648.825832133509
SILVER_LONGHAIR	5239.8622176027238
SINGAPURA	1097.6636642483058
SKYE_TERRIER	15404.958415241328
SLOVAKIAN_ROUGH_HAIRED_POINTER	12673.421083764608
SMALL_MONGREL_(UP_TO_10KG)	12025.38090058474
SMOOTH_COLLIE	3186.6261733929559
SNORKIE	14340.624497044186
SPANISH_GREYHOUND	8350.69403266169
SPRINGADOR	24222.41084880332
SPRINGERDOODLE	9795.9063731839578
SPRINGER_SPANIEL	19517.207522907865
SPROCKER_SPANIEL	22402.876631008829
SPROLLIE	50342.96976527325
ST._BERNARD	21636.204452010221
STAFFORDSHIRE_BULL_TERRIER	20735.32967304156
STANDARD_POODLE	5161.09774233526
STANDARD_SCHNAUZER	11585.492108498536
TABBY	16717.390155985013
TABBY_AND_TORTOISESHELL_SHORTHAIR	3962.2460507730311
TABBY_AND_WHITE_LONGHAIR	6880.3560170556666
TABBY_AND_WHITE_SHORTHAIR	3383.2536859675097
TABBY_SHORTHAIR	3936.0491718321955
TABBY_SPOTTED	2130.6929015741093
TIBETAN_MASTIFF	23683.114755617436
TIBETAN_TERRIER	11289.126189754341
TONKINESE	4083.0380075621542
TORTOISESHELL	416.38251041784116
TORTOISESHELL_SHORTHAIR	1981.3569479783937
TOYGER	1880.45548742638
TOY_POODLE	17886.448850025066
TRAILHOUND	227.00436791491038
TURKISH_ANGORA	30865.434132534814
TURKISH_VAN	106924.0566393725
VIZSLA	4367.9004003883019
WEIMARANER	40647.045827382484
WELSH_SPRINGER_SPANIEL	16778.239402058782
WELSH_TERRIER	4762.9664309036907
WESTIEPOO	7043.0751587054683
WEST_HIGHLAND_TERRIER	39151.77061202842
WEST_HIGHLAND_WHITE_TERRIER	38273.948135749029
WHIPPET	9683.0649304521212
WHITE	12340.771324896767
WIREHAIRED_VIZSLA	36841.888781671441
YELLOW_LABRADOR	21767.4320795745
YORKIE_RUSSELL	206.82461010179617
YORKSHIRE_TERRIER	31946.429161524109
ZUCHON	14724.606534726061
*/
